import rclpy
from rclpy.node import Node
from sensor_msgs.msg import NavSatFix
from std_msgs.msg import Float32, String
import socket
import json

class RobotPhoneBridge(Node):
    def __init__(self):
        super().__init__('robot_phone_bridge')
        
        # Publishers
        self.gps_pub = self.create_publisher(NavSatFix, '/gps/fix', 10)
        self.heading_pub = self.create_publisher(Float32, '/imu/yaw', 10)
        self.usb_pub = self.create_publisher(String, '/phone/usb_status', 10)
        self.bat_pub = self.create_publisher(String, '/phone/battery', 10)
        
        # Network Setup
        self.udp_ip = "0.0.0.0"
        self.udp_port = 5555
        self.sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        self.sock.bind((self.udp_ip, self.udp_port))
        self.sock.setblocking(False)
        
        # Run loop at 50Hz
        self.timer = self.create_timer(0.02, self.run_bridge)
        self.get_logger().info("ROS2 Bridge Active: Listening for Phone JSON...")

    def run_bridge(self):
        try:
            data, addr = self.sock.recvfrom(2048)
            msg_json = json.loads(data.decode('utf-8'))
            #self.get_logger().info(msg_json)
            
            # 1. Handle GPS
            if 'lat' in msg_json and 'lon' in msg_json:
                gps_msg = NavSatFix()
                gps_msg.header.stamp = self.get_clock().now().to_msg()
                gps_msg.header.frame_id = "gps_link"
                gps_msg.latitude = float(msg_json['lat'])
                gps_msg.longitude = float(msg_json['lon'])
                self.gps_pub.publish(gps_msg)

            # 2. Handle Heading
            if 'heading' in msg_json:
                head_msg = Float32()
                head_msg.data = float(msg_json['heading'])
                self.heading_pub.publish(head_msg)

            # 3. Handle USB Device Info
            if 'lastusb' in msg_json:
                usb_msg = String()
                usb_msg.data = str(msg_json['lastusb'])
                self.usb_pub.publish(usb_msg)
           
           # 3. Handle USB Device Info
            if 'battery' in msg_json:
                bat_msg = String()
                bat_msg.data = str(msg_json['battery'])
                self.bat_pub.publish(bat_msg)

        except (BlockingIOError, socket.error):
            pass # No data yet
        except json.JSONDecodeError:
            self.get_logger().error("Received malformed JSON!")
        except Exception as e:
            self.get_logger().error(f"Bridge Error: {e}")

def main(args=None):
    rclpy.init(args=args)
    bridge = RobotPhoneBridge()
    try:
        rclpy.spin(bridge)
    except KeyboardInterrupt:
        pass
    bridge.sock.shutdown()
    bridge.sock.close()
    bridge.destroy_node()
    rclpy.shutdown()

if __name__ == '__main__':
    main()
